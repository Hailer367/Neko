name: Neko Security Scan
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Scan target (e.g. GitHub URL or local path)'
        required: true
        default: 'https://github.com/lightsparkdev/python-sdk'
      model:
        description: 'LLM Model'
        required: true
        default: 'qwen3-coder-plus'
      encryption_password:
        description: 'Password for decrypting tokens'
        required: true

jobs:
  neko-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Decrypt QWEN_TOKENS
        env:
          QWEN_TOKENS: ${{ secrets.QWEN_TOKENS }}
          ENCRYPTION_PASSWORD: ${{ github.event.inputs.encryption_password || secrets.ENCRYPTION_PASSWORD }}
        run: |
          if [ -z "$QWEN_TOKENS" ]; then
            echo "::error::QWEN_TOKENS secret is missing!"
            exit 1
          fi
          # tr -d '[:space:]' removes any whitespace/newlines that cause "base64: invalid input"
          echo "$QWEN_TOKENS" | tr -d '[:space:]' | base64 -d > qwen-tokens.enc
          
          openssl enc -aes-256-cbc -d -salt -pbkdf2 \
            -in qwen-tokens.enc \
            -out qwen-tokens.tar.gz \
            -pass pass:"$ENCRYPTION_PASSWORD"
          
          mkdir -p ~/.cli-proxy-api/auth
          tar -xzf qwen-tokens.tar.gz -C ~/.cli-proxy-api/auth
          echo "token_count=$(ls ~/.cli-proxy-api/auth/qwen-*.json | wc -l)" >> $GITHUB_OUTPUT

      - name: Build Neko Agent
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: neko-agent:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Start CLIProxyAPI
        run: |
          curl -L https://github.com/router-for-me/CLIProxyAPI/releases/latest/download/CLIProxyAPI-linux-amd64 -o cliproxy
          chmod +x cliproxy
          # Start in background, it will pick up tokens from ~/.cli-proxy-api/auth
          ./cliproxy > cliproxy.log 2>&1 &
          sleep 5

      - name: Run Neko Scan
        env:
          NEKODB_TOKEN: ${{ secrets.NEKODB_TOKEN }}
          NEKODB_REPO: ${{ github.repository_owner }}/NekoDB
          TARGET_INPUT: ${{ github.event.inputs.target }}
        run: |
          # If target is a URL, clone it first
          if [[ "$TARGET_INPUT" == http* ]]; then
            git clone "$TARGET_INPUT" /tmp/scan-target
            TARGET_VOLUME="/tmp/scan-target"
          else
            TARGET_VOLUME="${{ github.workspace }}"
          fi

          docker run --network host \
            -v "$TARGET_VOLUME":/workspace \
            -e NEKODB_TOKEN=$NEKODB_TOKEN \
            -e NEKODB_REPO=$NEKODB_REPO \
            -e TARGET_PATH=/workspace \
            -e MODEL=${{ github.event.inputs.model || 'qwen3-coder-plus' }} \
            neko-agent:latest

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
